{% extends 'base.html' %}
{% load dict_extras %}

{% block content %}
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex gap-3 align-items-start">
      <div class="text-center" style="width: 88px;">
        {% with v=q_votes|get_item:question.id %}
          <div class="input-group input-group-sm" data-question-id="{{ question.id }}">
            <button
              class="btn btn-outline-secondary js-q-vote"
              type="button"
              data-id="{{ question.id }}"
              data-value="1"
              {% if not user.is_authenticated or v == 1 %}disabled{% endif %}
            >+</button>
            <input class="form-control text-center js-q-rating" value="{{ question.rating }}" readonly>
            <button
              class="btn btn-outline-secondary js-q-vote"
              type="button"
              data-id="{{ question.id }}"
              data-value="-1"
              {% if not user.is_authenticated or v == -1 %}disabled{% endif %}
            >-</button>
          </div>
        {% endwith %}
      </div>

      <div class="flex-grow-1">
        <h2 class="mb-2">{{ question.title }}</h2>
        <p class="text-muted mb-3">{{ question.text }}</p>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="text-muted">Tags:</span>
          {% for t in question.tags.all %}
            <a class="badge text-bg-light text-decoration-none" href="{% url 'tag' t.name %}">{{ t.name }}</a>
          {% empty %}
            <span class="text-muted">â€”</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<h4 class="mb-3">Answers</h4>

<div id="answers-list">
{% for a in page_obj.object_list %}
  {% include 'includes/answer_item.html' with a=a question=question a_votes=a_votes %}
{% empty %}
  <div class="text-muted">No answers yet.</div>
{% endfor %}


</div>

{% include 'includes/paginator.html' with page_obj=page_obj %}

{% if user.is_authenticated %}
  <h4 class="mt-4">Your answer</h4>
  <form method="post" action="{% url 'question_detail' question.id %}" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}{{ e }}{% endfor %}
      </div>
    {% endif %}

    <div class="mb-3">
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger small mt-1">
          {% for e in form.text.errors %}{{ e }}{% endfor %}
        </div>
      {% endif %}
    </div>
    <button class="btn btn-primary" type="submit">Answer</button>
  </form>
{% else %}
  <div class="alert alert-warning mt-4">
    To post an answer, please <a href="{% url 'login' %}?continue={{ request.get_full_path|urlencode }}" class="alert-link">log in</a>.
  </div>
{% endif %}
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/centrifuge@5/dist/centrifuge.min.js"></script>
<script>
(function(){
  var el=document.getElementById('answers-list');
  if(!el){return;}
  var ws="{{ CENTRIFUGO_WS_URL|default:'ws://127.0.0.1:8000/connection/websocket' }}";
  var c=new Centrifuge(ws,{});
  c.on('error',function(){});
  var sub=c.newSubscription("question:{{ question.id }}");
  sub.on('publication',function(ctx){
    if(!ctx||!ctx.data||!ctx.data.html){return;}
    el.insertAdjacentHTML('beforeend',ctx.data.html);
  });
  c.connect();
  sub.subscribe();
})();
</script>
{% endblock %}
